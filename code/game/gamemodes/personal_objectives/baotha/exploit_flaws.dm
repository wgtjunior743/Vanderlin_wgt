/datum/objective/personal/find_flaws
	name = "Exploit Flaws"
	category = "Baotha's Chosen"
	triumph_count = 2
	immediate_effects = list("Gained an ability to find flaws of others")
	rewards = list("2 Triumphs", "Baotha grows stronger")
	var/flaws_found = 0
	var/flaws_required = 10
	var/list/known_targets = list()

/datum/objective/personal/find_flaws/on_creation()
	. = ..()
	owner.current.add_spell(/datum/action/cooldown/spell/find_flaw, source = src)
	RegisterSignal(owner.current, COMSIG_FLAW_FOUND, PROC_REF(on_flaw_found))
	update_explanation_text()

/datum/objective/personal/find_flaws/Destroy()
	if(owner?.current)
		owner.current.remove_spell(/datum/action/cooldown/spell/find_flaw)
		UnregisterSignal(owner.current, COMSIG_FLAW_FOUND)
	return ..()

/datum/objective/personal/find_flaws/proc/on_flaw_found(datum/source, datum/flaw, mob/target)
	SIGNAL_HANDLER
	if(completed)
		return

	if(target in known_targets)
		to_chat(owner.current, span_warning("You've already discovered this person's flaw!"))
		return

	known_targets += target
	flaws_found++

	if(flaws_found >= flaws_required)
		complete_objective()
	else
		to_chat(owner.current, span_notice("You have found [target]'s flaw! Find [flaws_required - flaws_found] more flaws in others to complete Baotha's will!"))

/datum/objective/personal/find_flaws/proc/complete_objective()
	to_chat(owner.current, span_greentext("You've found out enough flaws of others to satisfy Baotha!"))
	owner.current.adjust_triumphs(triumph_count)
	completed = TRUE
	adjust_storyteller_influence(BAOTHA, 20)
	escalate_objective()
	UnregisterSignal(owner.current, COMSIG_FLAW_FOUND)

/datum/objective/personal/find_flaws/update_explanation_text()
	explanation_text = "Find out at least [flaws_required] flaws of others and exploit them to entertain Baotha!"
